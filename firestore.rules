
/**
 * @fileoverview Firestore Security Rules for the workout application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all user-generated data
 * (custom workouts, workout logs, equipment, profile, exercise preferences). The master exercise
 * data is publicly readable, but only authenticated users can add or modify it.
 *
 * Data Structure:
 * - /users/{userId}: Stores user identity. Only the authenticated user can read/write their own identity doc.
 * - /users/{userId}/profile/{profileId}: Stores user settings & goals. Owner-only access.
 * - /users/{userId}/equipment/{equipmentId}: Stores user's equipment list. Owner-only access.
 * - /users/{userId}/progressLogs/{progressLogId}: Stores user's progress data (e.g. weight). Owner-only access.
 * - /users/{userId}/exercisePreferences/{exerciseId}: Stores user-specific video links for exercises. Owner-only access.
 * - /exercises/{exerciseId}: Stores master exercise data. Publicly readable, but authenticated users can create and update exercises.
 * - /users/{userId}/customWorkouts/{customWorkoutId}: Stores custom workouts. Only the owning user can read/write.
 * - /users/{userId}/workoutLogs/{workoutLogId}: Stores workout logs. Only the owning user can read/write.
 *
 * Key Security Decisions:
 * - User listing is disallowed to prevent unauthorized data access.
 * - The /exercises collection is read-only for all users, except for creation and updates by authenticated users.
 * - Default security posture for ambiguous relationships is strict owner-only access.
 *
 * Denormalization for Authorization:
 * - The 'userId' is stored within CustomWorkout, WorkoutLog, UserEquipment and ProgressLog documents to eliminate `get()` calls in security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Manages user identity data. Only the user with the matching {userId} can read or write their profile.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is disabled for privacy

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && request.resource.data.id == resource.data.id; //Immutable ID
      allow delete: if isOwner(userId);

      /**
       * @description Manages the user's fitness goals and profile settings.
       * @path /users/{userId}/profile/{profileId}
       */
      match /profile/{profileId} {
        allow get, list, create, update, delete: if isOwner(userId);
      }
      
      /**
       * @description Manages the user's preferences for specific exercises (e.g., linked video).
       * This rule allows the owner to list their own preferences.
       * @path /users/{userId}/exercisePreferences
       */
      match /exercisePreferences/{exerciseId} {
        allow list: if isOwner(userId);
        allow get, create, update, delete: if isOwner(userId);
      }

      /**
       * @description Manages the user's list of available equipment.
       * @path /users/{userId}/equipment/{equipmentId}
       */
      match /equipment/{equipmentId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.keys().hasAll(['name']);
        allow update: if isOwner(userId); // Can update name
        allow delete: if isOwner(userId);
      }

      /**
       * @description Manages user progress entries like body weight.
       * @path /users/{userId}/progressLogs/{progressLogId}
       */
      match /progressLogs/{progressLogId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId; //Immutable user ID
        allow delete: if isOwner(userId);
      }

      /**
       * @description Manages custom workout routines created by users.
       * @path /users/{userId}/customWorkouts/{customWorkoutId}
       */
      match /customWorkouts/{customWorkoutId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId; //Immutable user ID
        allow delete: if isOwner(userId);
      }

      /**
       * @description Manages workout logs for users.
       * @path /users/{userId}/workoutLogs/{workoutLogId}
       */
      match /workoutLogs/{workoutLogId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId; //Immutable user ID
        allow delete: if isOwner(userId);
      }

      /**
       * @description Manages workout locations for users (home gym, commercial gym, etc.).
       * @path /users/{userId}/locations/{locationId}
       */
      match /locations/{locationId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId; //Immutable user ID
        allow delete: if isOwner(userId);
      }

      /**
       * @description Manages program enrollments for users (structured workout programs).
       * @path /users/{userId}/programEnrollments/{enrollmentId}
       */
      match /programEnrollments/{enrollmentId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      /**
       * @description User's accepted friends list for leaderboard comparisons.
       * @path /users/{userId}/friends/{friendId}
       */
      match /friends/{friendId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }
    
    /**
     * @description Manages the master exercise list. This collection is pre-populated and read-only for all users,
     * but authenticated users can create or update exercises.
     * @path /exercises/{exerciseId}
     */
    match /exercises/{exerciseId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    /**
     * @description Stores feedback and suggestions from users.
     * @path /feedback/{feedbackId}
     */
    match /feedback/{feedbackId} {
      // Anyone authenticated can create feedback
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      // Only allow reading your own feedback or if you're an admin
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      // Admin email can read all feedback (for review)
      allow list: if isSignedIn() && request.auth.token.email == 'matthewcb4@gmail.com';
      // Users can delete their own feedback
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Pre-computed leaderboard snapshots. Readable by any authenticated user.
     * Only Cloud Functions can write (via admin SDK).
     * @path /leaderboards/{snapshotId}
     */
    match /leaderboards/{snapshotId} {
      allow read: if isSignedIn();
      allow write: if false; // Admin SDK only (Cloud Functions)
    }

    /**
     * @description Friend connection requests between users.
     * Users can read requests they sent or received.
     * Users can create requests where they are the sender.
     * Users can update requests they received (to accept/decline).
     * @path /friendRequests/{requestId}
     */
    match /friendRequests/{requestId} {
      allow read: if isSignedIn() && 
        (resource.data.senderId == request.auth.uid || resource.data.receiverId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.receiverId == request.auth.uid;
      allow delete: if isSignedIn() && 
        (resource.data.senderId == request.auth.uid || resource.data.receiverId == request.auth.uid);
    }
  }
}
