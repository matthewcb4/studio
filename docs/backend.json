
{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the User entity." },
        "email": { "type": "string", "description": "User's email address.", "format": "email" },
        "displayName": { "type": "string", "description": "User's display name." }
      },
      "required": ["id", "email"]
    },
    "UserProfile": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "UserProfile",
        "type": "object",
        "description": "Stores user-specific settings and fitness goals.",
        "properties": {
            "id": { "type": "string", "description": "Unique identifier for the UserProfile, matching the user's UID." },
            "targetWeight": { "type": "number", "description": "User's target body weight in lbs." },
            "strengthGoal": { "type": "string", "description": "User's primary strength goal." },
            "muscleGoal": { "type": "string", "description": "User's primary muscle gain goal." },
            "fatLossGoal": { "type": "string", "description": "User's primary fat loss goal." },
            "biologicalSex": { "type": "string", "enum": ["Male", "Female"], "description": "User's biological sex to determine body outline for heatmap." }
        },
        "required": ["id"]
    },
    "UserEquipment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserEquipment",
      "type": "object",
      "description": "Represents a piece of equipment owned by a user.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the equipment." },
        "userId": { "type": "string", "description": "Reference to the User." },
        "name": { "type": "string", "description": "Name of the equipment." }
      },
      "required": ["id", "userId", "name"]
    },
    "Exercise": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Exercise",
      "type": "object",
      "description": "Represents an exercise in the master exercise database.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the Exercise entity." },
        "name": { "type": "string", "description": "Name of the exercise." },
        "description": { "type": "string", "description": "Description of the exercise." },
        "category": { "type": "string", "description": "The muscle group category of the exercise." }
      },
      "required": ["id", "name"]
    },
    "UserExercisePreference": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserExercisePreference",
      "type": "object",
      "description": "Stores user-specific preferences for a master exercise, like a linked video.",
      "properties": {
        "id": { "type": "string", "description": "The master exercise ID this preference is for." },
        "userId": { "type": "string", "description": "Reference to the User." },
        "videoId": { "type": "string", "description": "The 11-character YouTube video ID linked by the user." }
      },
      "required": ["id", "userId"]
    },
    "CustomWorkout": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CustomWorkout",
      "type": "object",
      "description": "Represents a custom workout routine created by a user, with support for supersets.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the CustomWorkout entity." },
        "userId": { "type": "string", "description": "Reference to User. (Relationship: User 1:N CustomWorkout)" },
        "name": { "type": "string", "description": "Name of the custom workout." },
        "exercises": {
          "type": "array",
          "description": "A flat array of exercises. Exercises in the same superset share a 'supersetId'.",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "exerciseId": { "type": "string" },
              "exerciseName": { "type": "string" },
              "sets": { "type": "number" },
              "reps": { "type": "string" },
              "supersetId": { "type": "string" }
            },
            "required": ["id", "exerciseId", "exerciseName", "sets", "reps", "supersetId"]
          }
        }
      },
      "required": ["id", "userId", "name", "exercises"]
    },
    "WorkoutLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WorkoutLog",
      "type": "object",
      "description": "Represents a log of a completed workout session.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the WorkoutLog entity." },
        "userId": { "type": "string", "description": "Reference to User. (Relationship: User 1:N WorkoutLog)" },
        "workoutName": { "type": "string", "description": "Name of the workout performed." },
        "date": { "type": "string", "description": "Date of the workout log.", "format": "date-time" },
        "duration": { "type": "string", "description": "Duration of the workout." },
        "volume": { "type": "number", "description": "Total weight lifted during the workout." },
        "rating": { "type": "number", "description": "User's star rating of the workout, from 1 to 5." },
        "exercises": {
          "type": "array",
          "description": "Array of exercises performed during the workout.",
          "items": {
            "type": "object",
            "properties": {
              "exerciseId": { "type": "string" },
              "exerciseName": { "type": "string" },
              "sets": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "reps": { "type": "number" },
                    "weight": { "type": "number" }
                  },
                  "required": ["reps", "weight"]
                }
              }
            },
            "required": ["exerciseId", "exerciseName", "sets"]
          }
        }
      },
      "required": ["id", "userId", "workoutName", "date"]
    },
    "ProgressLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ProgressLog",
      "type": "object",
      "description": "Represents a user's progress entry, such as body weight.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the progress log." },
        "userId": { "type": "string", "description": "Reference to the User." },
        "date": { "type": "string", "format": "date-time", "description": "The date of the log entry." },
        "weight": { "type": "number", "description": "User's body weight in lbs for this entry." }
      },
      "required": ["id", "userId", "date", "weight"]
    }
  },
  "auth": {
    "providers": ["password", "anonymous", "google.com"]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": { "$ref": "#/backend/entities/User" },
          "description": "Stores user identity information. Path-based ownership: only the user with the matching {userId} can read/write.",
          "params": [{ "name": "userId", "description": "The unique identifier of the user." }]
        }
      },
      {
        "path": "/users/{userId}/profile/{profileId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": { "$ref": "#/backend/entities/UserProfile" },
          "description": "Stores user-specific settings and fitness goals. This is a singleton document per user, typically with a fixed ID like 'main'.",
          "params": [
            { "name": "userId", "description": "The unique identifier of the user." },
            { "name": "profileId", "description": "The unique identifier of the profile document (e.g., 'main')." }
          ]
        }
      },
      {
        "path": "/users/{userId}/equipment/{equipmentId}",
        "definition": {
          "entityName": "UserEquipment",
          "schema": { "$ref": "#/backend/entities/UserEquipment" },
          "description": "Stores the user's personal equipment list. Path-based ownership ensures only the user can manage their equipment.",
          "params": [
            { "name": "userId", "description": "The unique identifier of the user." },
            { "name": "equipmentId", "description": "The unique identifier of the equipment." }
          ]
        }
      },
      {
        "path": "/exercises/{exerciseId}",
        "definition": {
          "entityName": "Exercise",
          "schema": { "$ref": "#/backend/entities/Exercise" },
          "description": "Stores master exercise data. This collection is pre-populated and publicly readable. User-specific customizations are stored separately.",
          "params": [{ "name": "exerciseId", "description": "The unique identifier of the exercise." }]
        }
      },
      {
        "path": "/users/{userId}/exercisePreferences/{exerciseId}",
        "definition": {
          "entityName": "UserExercisePreference",
          "schema": { "$ref": "#/backend/entities/UserExercisePreference" },
          "description": "Stores user-specific customizations for an exercise, such as a linked YouTube video. Path-based ownership ensures only the user can manage their preferences.",
          "params": [
            { "name": "userId", "description": "The unique identifier of the user." },
            { "name": "exerciseId", "description": "The unique identifier of the master exercise this preference applies to." }
          ]
        }
      },
      {
        "path": "/users/{userId}/customWorkouts/{customWorkoutId}",
        "definition": {
          "entityName": "CustomWorkout",
          "schema": { "$ref": "#/backend/entities/CustomWorkout" },
          "description": "Stores custom workout routines created by users. Path-based ownership: only the user with the matching {userId} can read/write. Includes denormalized 'userId' for authorization independence.",
          "params": [
            { "name": "userId", "description": "The unique identifier of the user." },
            { "name": "customWorkoutId", "description": "The unique identifier of the custom workout." }
          ]
        }
      },
      {
        "path": "/users/{userId}/workoutLogs/{workoutLogId}",
        "definition": {
          "entityName": "WorkoutLog",
          "schema": { "$ref": "#/backend/entities/WorkoutLog" },
          "description": "Stores workout logs for users. Path-based ownership: only the user with the matching {userId} can read/write. Includes denormalized 'userId' for authorization independence.",
          "params": [
            { "name": "userId", "description": "The unique identifier of the user." },
            { "name": "workoutLogId", "description": "The unique identifier of the workout log." }
          ]
        }
      },
      {
        "path": "/users/{userId}/progressLogs/{progressLogId}",
        "definition": {
          "entityName": "ProgressLog",
          "schema": { "$ref": "#/backend/entities/ProgressLog" },
          "description": "Stores user progress data, such as daily weight. Path-based ownership ensures only the user can manage their logs.",
          "params": [
            { "name": "userId", "description": "The unique identifier of the user." },
            { "name": "progressLogId", "description": "The unique identifier for the progress entry." }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support user authentication, exercise data, custom workouts, workout logging, and progress tracking. It prioritizes authorization independence by leveraging path-based ownership for user-specific data and segregation for the master exercise database.  \n\nThe CustomWorkout entity now uses a flat 'exercises' array. Each exercise has a 'supersetId', which allows grouping exercises into supersets without violating Firestore's rule against nested arrays. This is more scalable and query-friendly.\n\nAuthorization Independence is achieved as follows:\n*   `/users/{userId}/customWorkouts`: Custom workout documents are owned by the user identified by `{userId}`. No external data lookups are required to authorize access.  The `userId` is stored within each document to eliminate the need for `get()` calls in security rules.\n*   `/users/{userId}/workoutLogs`: Workout logs are owned by the user identified by `{userId}`. Each `workoutLog` document includes the `userId`, ensuring that authorization rules do not require reading other documents.\n*   `/exercises`: The master exercise data is globally readable, so authorization independence isn't a concern here.\n*   `/users/{userId}/equipment`: This new collection stores user-specific equipment. Ownership is tied to the user via the path, ensuring only the logged-in user can manage their equipment list.\n*   `/users/{userId}/profile/{profileId}`: This new subcollection stores user-specific profile data like goals. It's structured as a subcollection to keep it separate from the main user identity document, and is owner-only access.\n*   `/users/{userId}/exercisePreferences/{exerciseId}`: This new collection stores user-specific video links for exercises, ensuring users do not overwrite each other's preferences.\n\nQAPs are addressed through structural segregation and path-based ownership:\n*   The `/exercises` collection is separate and read-only for all users, satisfying the requirement for a pre-populated, read-only master list.\n*   User-specific collections (`/users/{userId}/customWorkouts`, `/users/{userId}/workoutLogs`, `/users/{userId}/equipment`, `/users/{userId}/profile`, `/users/{userId}/exercisePreferences`) provide a secure and scalable way to manage user data. List operations are inherently secured by requiring the correct `userId` in the path.  This structure supports efficient queries for a user's custom workouts or workout logs."
  }
}
